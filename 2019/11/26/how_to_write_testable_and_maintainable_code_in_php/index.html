<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>如何撰寫可測試與可維護 PHP 程式碼 | WadeHuang1993&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="如何撰寫可測試與可維護 PHP 程式碼框架(Framework) 是一種可以讓開發應用程式更快速、便利的工具，但是快速與便利的開發過程卻經常產生 技術債。技術債產生的主因是開發人員沒有把程式的可維護性當作工作目標。在缺少單元測試和良好的程式結構下，功能異動跟除錯都會變得越來越困難。 本文章將教您如何把程式碼變得更有結構，讓程式碼變得可測試與易於維護。（還有節省你的時間） 你將會學到 DRY 原則">
<meta name="keywords" content="PHP, OOP, JavaScript, Web development">
<meta property="og:type" content="article">
<meta property="og:title" content="如何撰寫可測試與可維護 PHP 程式碼">
<meta property="og:url" content="https:&#x2F;&#x2F;wadehuang1993.github.io&#x2F;blog&#x2F;2019&#x2F;11&#x2F;26&#x2F;how_to_write_testable_and_maintainable_code_in_php&#x2F;index.html">
<meta property="og:site_name" content="WadeHuang1993&#39;s Blog">
<meta property="og:description" content="如何撰寫可測試與可維護 PHP 程式碼框架(Framework) 是一種可以讓開發應用程式更快速、便利的工具，但是快速與便利的開發過程卻經常產生 技術債。技術債產生的主因是開發人員沒有把程式的可維護性當作工作目標。在缺少單元測試和良好的程式結構下，功能異動跟除錯都會變得越來越困難。 本文章將教您如何把程式碼變得更有結構，讓程式碼變得可測試與易於維護。（還有節省你的時間） 你將會學到 DRY 原則">
<meta property="og:locale" content="zh-TW">
<meta property="og:updated_time" content="2019-11-29T08:01:34.656Z">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="WadeHuang1993&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">WadeHuang1993&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">WadeHuang1993 的學習迷航記</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">首頁</a>
        
          <a class="main-nav-link" href="/blog/archives">文章列表</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://wadehuang1993.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-how_to_write_testable_and_maintainable_code_in_php" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2019/11/26/how_to_write_testable_and_maintainable_code_in_php/" class="article-date">
  <time datetime="2019-11-26T04:10:54.000Z" itemprop="datePublished">2019-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      如何撰寫可測試與可維護 PHP 程式碼
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      

        <h1><span id="如何撰寫可測試與可維護-php-程式碼">如何撰寫可測試與可維護 PHP 程式碼</span></h1><p><strong>框架(Framework)</strong> 是一種可以讓開發應用程式更快速、便利的工具，但是快速與便利的開發過程卻經常產生 <strong>技術債</strong>。<strong>技術債產生的主因是開發人員沒有把程式的可維護性當作工作目標</strong>。在缺少單元測試和良好的程式結構下，功能異動跟除錯都會變得越來越困難。</p>
<p>本文章將教您如何把程式碼變得更有結構，讓程式碼變得可測試與易於維護。（還有節省你的時間）</p>
<h2><span id="你將會學到">你將會學到</span></h2><ul>
<li>DRY 原則</li>
<li>依賴注入 (Dependency Injection)</li>
<li>介面 (Interfaces)</li>
<li>PHPUnit 單元測試 (Unit Tests with PHPUnit)</li>
</ul>
<p>首先來看一段工作中常見的程式碼，這是一個可能會出現在任何框架中的 Model 層類別。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCurrentUser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user_id = $_SESSION[<span class="string">'user_id'</span>];</span><br><span class="line"></span><br><span class="line">        $user = App::db-&gt;select(<span class="string">'id, username'</span>)</span><br><span class="line">            -&gt;where(<span class="string">'id'</span>, $user_id)</span><br><span class="line">            -&gt;limit(<span class="number">1</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> ($user-&gt;num_results() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;row();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個程式碼可以正常運作！但仍需要被改進：</p>
<ol>
<li>這樣的程式碼沒辦法進行測試<ul>
<li>程式碼直接使用了全域變數 <code>$_SESSION</code>。單元測試框架（PHPUnit) 都是透過 CLI (command-line Interface) 執行 PHP。因此在執行單元測試的過程中，<code>$_SESSION</code>、<code>$_SERVER</code> 等等全域變數都是沒辦法取得的。</li>
<li>把資料庫操作邏輯寫在程式碼中。<strong>單元測試是用來測試程式碼，而不是用來測試資料</strong>。一般來說會在單元測試中隔離資料庫操作邏。</li>
</ul>
</li>
<li>這段程式碼可能不夠好維護。舉例來說，如果我們要更換資料來源時(如 DB 改成 Redis)，我們必須修改應用程式中任何使用 <code>App::db</code> 資料庫物件的程式碼。 再來，如果要把這段程式碼改成不只是撈取 Session 的 User 時怎麼辦？</li>
</ol>
<h3><span id="嘗試使用單元測試">嘗試使用單元測試</span></h3><p>我們先試著幫上面的程式碼建立一個單元測試。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModelTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetUser</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">        $currentUser = $user-&gt;getCurrentUser();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">1</span>, $currentUser-&gt;id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個測試案例將會無法通過，讓我們看一下原因：</p>
<ol>
<li>單元測試的環境是 CLI-PHP，所以 <code>User</code> 物件使用的 <code>$_SESSION</code> 全域變數並不存在。</li>
<li>測試案例中沒有任何資料庫連線的設定。這意味著，為了讓資料庫操作可以運作，我們將需要啟動整個應用程式來初始化 <code>App</code> 物件和 <code>db</code> 物件。甚至還需要一個有效的資料庫連線來進行測試。</li>
</ol>
<p>為了讓單元測試可以運作，我們必須完成：</p>
<ol>
<li>建立一個專門為 CLI 環境運作的設定檔案，讓 PHPUnit 可以取得全域變數。</li>
<li>依賴資料庫連線。這會讓單元測試直接使用真實的資料庫。但若資料庫中沒有我們期望的資料時該怎麼進行測試？資料庫連線很慢又該如何解決？</li>
<li>啟動整個應用程式初始化核心元件。這會增加測試的開銷，大大降低單元測試的速度。</li>
</ol>
<p>當然，上述的作法都不可行！</p>
<blockquote>
<p>理想狀況下，大部分的程式要能夠獨立於 <strong>框架</strong>，並且被執行測試。</p>
</blockquote>
<p>因此，接下來著手研究如何解除程式對 <strong>框架</strong> 的依賴。</p>
<h2><span id="dry-原則-dont-repeat-yourself">DRY 原則 (Don’t repeat yourself)</span></h2><p>假設有一新需求要可以隨意撈取某個 User 的資料，但我們的程式只有 <code>User-&gt;getCurrentUser()</code> 時怎麼辦？若直接寫一個新的函式來撈取隨意一個 User 的資料，就會違反 DRY 原則。因為除了 <code>$user_id</code> 不一樣以外，其他邏輯都相同。</p>
<p>因此我們將改寫第一個範例，讓原本的函式變得更有彈性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($user_id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = App::db-&gt;select(<span class="string">'user'</span>)</span><br><span class="line">        -&gt;where(<span class="string">'id'</span>, $user_id)</span><br><span class="line">        -&gt;limit(<span class="number">1</span>)</span><br><span class="line">        -&gt;get();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> ($user-&gt;num_results() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;row();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>調整項目：</p>
<ol>
<li>把 <code>$user_id</code> 當作參數來撈取使用者資料。</li>
<li>函式名稱也從 <code>getCurrentUser</code> 改成 <code>getUser</code>，並可以在應用程式中被任意使用。</li>
</ol>
<p>現在，<code>getUser</code> 不但可以撈取當下的使用者資訊(CurrentUser)，也可以隨意撈取任一使用者資訊了！</p>
<p>當程式碼不再依賴其他功能（如 <code>$_SESSION</code> 等全域變數）時，就可以變得更模組化、更容易重複使用。<br>但程式碼現在還是沒辦法通過測試，因為我們仍依賴著資料庫連線邏輯。</p>
<h2><span id="依賴注入dependency-injection">依賴注入(Dependency Injection)</span></h2><p>接下來將使用 <strong>依賴注入</strong> 來解決資料庫連線的依賴問題。<br>當我們把資料庫連線的邏輯從 <code>User</code> 類別抽離出去，並且以參數的形式傳入 <code>User</code> 類別時，會長得像下面的程式碼：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($db_connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_db = $db_connection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($user_id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;_db-&gt;select(<span class="string">'user'</span>)</span><br><span class="line">            -&gt;where(<span class="string">'id'</span>, $user_id)</span><br><span class="line">            -&gt;limit(<span class="number">1</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($user-&gt;num_results() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;row();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依賴注入，即透過參數傳入依賴。讓 <code>User</code> 類別不再依賴真實的資料庫連線邏輯，也不依賴任何全域物件(<code>App::db</code>)。</p>
<p>當 <code>User</code> 類別不再直接 <strong>依賴</strong> 資料庫連線邏輯時，我們可以傳入不同的 <code>資料來源</code>，從不同的資料來源撈取使用者資訊，如：Database、JSON、SESSION …等。</p>
<p>到目前為止，我們的 <code>User</code> 類別已經可以通過測試。<br>因為我們可以自己決定要傳入哪些 <code>user_id</code> 與 <code>資料來源</code>，並且測試函式的執行結果。接下來讓我們來看看，要如何對使用依賴注入的程式撰寫單元測試。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Mockery</span> <span class="title">as</span> <span class="title">Mock</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Fideloper</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondUserTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetCurrentUserMock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $db_connection = <span class="keyword">$this</span>-&gt;_mockDb();</span><br><span class="line"></span><br><span class="line">        $user = <span class="keyword">new</span> User($db_connection);</span><br><span class="line"></span><br><span class="line">        $result = $user-&gt;getUser(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        $expected = <span class="keyword">new</span> StdClass();</span><br><span class="line">        $expected-&gt;id = <span class="number">1</span>;</span><br><span class="line">        $expected-&gt;username = <span class="string">'fideloper'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals($expected-&gt;id, $result-&gt;id, <span class="string">'User ID set correctly'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals($expected-&gt;username, $result-&gt;username,  <span class="string">'Username set correctly'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_mockDb</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// "Mock" (stub) database row result object    </span></span><br><span class="line">        <span class="comment">// 模擬 database 撈取出來的 row 物件</span></span><br><span class="line">        $returnResult = <span class="keyword">new</span> StdClass();</span><br><span class="line">        $returnResult-&gt;id = <span class="number">1</span>;</span><br><span class="line">        $returnResult-&gt;username = <span class="string">'fideloper'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mock database result object</span></span><br><span class="line">        <span class="comment">// 透過 Mock 模擬資料庫操作結果物件</span></span><br><span class="line">        $result = Mock::mock(<span class="string">'DbResult'</span>);</span><br><span class="line">        $result-&gt;shouldReceive(<span class="string">'num_results'</span>)-&gt;once()-&gt;andReturn(<span class="number">1</span>);</span><br><span class="line">        $result-&gt;shouldReceive(<span class="string">'row'</span>)-&gt;once()-&gt;andReturn($returnResult);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mock database connection object</span></span><br><span class="line">        <span class="comment">// 透過 Mockery 模擬資料庫連接物件</span></span><br><span class="line">        $db = Mock::mock(<span class="string">'DbConnection'</span>);</span><br><span class="line"></span><br><span class="line">        $db-&gt;shouldReceive(<span class="string">'select'</span>)-&gt;once()-&gt;andReturn($db);</span><br><span class="line">        $db-&gt;shouldReceive(<span class="string">'where'</span>)-&gt;once()-&gt;andReturn($db);</span><br><span class="line">        $db-&gt;shouldReceive(<span class="string">'limit'</span>)-&gt;once()-&gt;andReturn($db);</span><br><span class="line">        $db-&gt;shouldReceive(<span class="string">'get'</span>)-&gt;once()-&gt;andReturn($result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $db;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我在單元測試中加入了新東西：<code>Mockery</code>。 Mockery 讓你可以模擬 PHP 物件（建立假物件）。在範例中，我們建立了 <code>DbConnection</code> 的假物件，透過這個假物件，可以讓單元測試不需進行<strong>真實的資料庫連線</strong>，只需專注在測試 <code>User</code> Model 類別的邏輯。</p>
<p>在範例中，建立 <code>DbConnection</code> 連線假物件時，我們需要告訴假物件 <code>select</code>, <code>where</code>, <code>limit</code> 和 <code>get</code> 方法都必須被調用。為了模擬資料庫連線物件總是回傳 <code>$this</code> 來達到方法鏈(Method chaining)的效果，我還設定這些方法被調用後要回傳 <code>DbConnection</code> 連線的假物件。注意，在 <code>get</code> 方法調用後，我回傳的是一個 <code>stdClass</code> 物件，模擬被從資料庫撈出來的使用者資料。</p>
<p>Mockery 解決了一些問題：</p>
<ol>
<li>讓單元測試只測試 <code>User</code> 類別的邏輯，不再需要測試資料庫連線。</li>
<li>我們可以控制 <code>假資料庫連線物件</code> 的輸入和輸出。我們可以知道輸入 user ID “1” 後，<code>假資料庫連線物件</code> 會回傳一個假的 user 資料。因此測試環境已經不需要依賴真實的資料庫連線就可以進行測試。</li>
<li>在執行測試時，不再需要為了初始化資料庫連線而啟動整個應用程式。</li>
</ol>
<p>但我們還可以做得更好！</p>
<h2><span id="介面-interfaces">介面 (Interfaces)</span></h2><p>為了進一步改善，我們可以定義並實做一個 <strong>介面</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserRepositoryInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($user_id)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlUserRepository</span> <span class="keyword">implements</span> <span class="title">UserRepositoryInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_db;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($db_conn)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_db = $db_conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($user_id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;_db-&gt;select(<span class="string">'user'</span>)</span><br><span class="line">            -&gt;where(<span class="string">'id'</span>, $user_id)</span><br><span class="line">            -&gt;limit(<span class="number">1</span>)</span><br><span class="line">            -&gt;get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($user-&gt;num_results() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $user-&gt;row();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $userStore;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepositoryInterface $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userStore = $user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($user_id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;userStore-&gt;getUser($user_id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我在這個例子中做了幾件事：</p>
<ol>
<li>替<strong>資料來源物件</strong>定義一個介面：<code>UserRepositoryInterface</code>，這個介面公開了一個方法為：<code>addUser()</code>。</li>
<li>實作 <code>UserRepositoryInterface</code> 介面。在範例中我們建立一個 MySQL 資料庫操作類別 <code>MysqlUserRepository</code> 來實作介面。這個類別接受一個資料庫連接線物件 <code>$db_conneect</code>，並且透過這個物件來撈取使用者資訊。</li>
<li>最後，替 <code>User</code> 類別建構函式的參數加上型別：<code>UserRepositoryInterface</code> 介面。這麼一來 <code>User</code> 類別就可以透過型別檢查機制 (Type Hinting) 確保被注入的 <code>資料來源</code> 總是可以提供 <code>addUser()</code> 方法。</li>
</ol>
<blockquote>
<p>當 User 類別在建構函式使用型別檢查 (Type Hinting) 對參數宣告型別為 <strong>UserRepositoryInterface</strong> 介面時，表示以後依賴注入的參數一定都要實作 <strong>UserRepositoryInterface</strong> 介面，並且實作介面的所有 Public 方法。</p>
</blockquote>
<p>這是為了確保 <code>User</code> 類別一定可以使用依賴注入進來的 <strong>資料來源物件</strong> 的 <code>getUser()</code> 方法。若傳遞進來的來源物件沒有實作 UserRepositoryInterface 介面，程式就會出現型別錯誤。</p>
<p>這樣做有什麼效果？</p>
<ol>
<li>我們的程式碼已經完全變得可測試了，現在可以輕易的透過 Mock 替換 <code>User</code> 類別的資料來源物件。</li>
<li>程式碼變得更容易維護。現在可以在不修改 <code>User</code> 類別的情況下，隨意切換 <code>資料來源</code>。</li>
<li>我們可以新增任意的 <code>資料來源物件</code>，例如：ArrayUser, MongoDbUser, CouchDbUser, MemoryUser, SessionUser …等。</li>
<li>如果需要的話，可以輕易地將任何的 <code>資料來源物件</code> 傳遞給 <code>User</code> 類別使用。假設現在要切換 SQL 的話，只需要新增一個實作 <code>UserRepositoryInterface</code> 的類別（例如 <code>MongoDbUser</code>），並且將它注入到 `User 類別中。</li>
</ol>
<p>導入介面後，我們就可以簡化一下單元測試！</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">Mockery</span> <span class="title">as</span> <span class="title">Mock</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Fideloper</span>\<span class="title">User</span>;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThirdUserTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetCurrentUserMock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $userRepo = <span class="keyword">$this</span>-&gt;_mockUserRepo();</span><br><span class="line"></span><br><span class="line">        $user = <span class="keyword">new</span> User( $userRepo );</span><br><span class="line"></span><br><span class="line">        $result = $user-&gt;getUser( <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">        $expected = <span class="keyword">new</span> StdClass();</span><br><span class="line">        $expected-&gt;id = <span class="number">1</span>;</span><br><span class="line">        $expected-&gt;username = <span class="string">'fideloper'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals($expected-&gt;id, $result-&gt;id, <span class="string">'User ID set correctly'</span> );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assertEquals($expected-&gt;username, $result-&gt;username, <span class="string">'Username set correctly'</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_mockUserRepo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Mock expected result</span></span><br><span class="line">        <span class="comment">// 模擬預期結果</span></span><br><span class="line">        $result = <span class="keyword">new</span> StdClass();</span><br><span class="line">        $result-&gt;id = <span class="number">1</span>;</span><br><span class="line">        $result-&gt;username = <span class="string">'fideloper'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Mock any user repository</span></span><br><span class="line">        <span class="comment">// 建立任何實作 UserRepositoryInterface 的假物件</span></span><br><span class="line">        $userRepo = Mock::mock(<span class="string">'Fideloper\Third\Repository\UserRepositoryInterface'</span>);</span><br><span class="line">        $userRepo-&gt;shouldReceive(<span class="string">'getUser'</span>)-&gt;once()-&gt;andReturn( $result );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $userRepo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>範例中我們簡單地利用 Mock 建立 <code>資料來源物件</code> 的假物件，並告訴 <strong>假物件</strong> 的 <code>getUser()</code> 被調用時應該怎麼做。</p>
<h2><span id="總結">總結</span></h2><p>經過了這篇文章的教學，我們完成了下列事項：</p>
<ol>
<li>讓我們的程式碼保持 DRY 原則，並且可以被重複使用。</li>
<li>建立了 <strong>可維護</strong> 的程式碼 - 若需要的話，我們可以在整個應用程式中，隨意替 <code>User</code> 類別切換 <code>資料來源物件</code>。</li>
<li>程式碼的變得 <strong>可測試</strong> - 我們可以簡單地使用 Mock 技術模擬資料庫的假物件。不再需要為了進行測試，而啟動整個應用程式或建立測試用的資料庫來進行資料庫連線。</li>
<li>學習到如何使用 <strong>依賴注入（Dependency Injection）</strong> 技術和 <strong>導入介面（Interface）</strong>，讓既有的程式碼變得 <strong>可測試</strong> 與 <strong>容易維護</strong>。</li>
</ol>
<p>我相信您已經註意到，程式碼雖然變得 <strong>可維護性</strong> 和 <strong>可測試性</strong>，但卻也添加了許多程式碼，這經常反對聲量：「程式碼變得更複雜！」。確實，這樣子的開發方式不論是對原作者或開發團隊，都需要對程式碼有更深入的了解。</p>
<p>但是，比起日增月益的 <strong>技術債</strong> ，這樣代價的其實是 CP 值很高的！</p>
<ul>
<li>程式碼變得更容易維護，可以讓改變都發生在同一個地方，而不是散落在整個應用程式中。</li>
<li>能夠快速地進行單元測試，開發中導入單元測試可以大大減少程式碼的錯誤。尤其是長期維護或龐大複雜的專案。</li>
<li>雖然開發過程會多做一些工作，但總是可以節省工程師未來維護程式的時間，以及發生頭痛的機率！</li>
</ul>
<h2><span id="參考連結">參考連結：</span></h2><ul>
<li><a href="https://code.tutsplus.com/tutorials/how-to-write-testable-and-maintainable-code-in-php--net-31726" target="_blank" rel="noopener">原文: How to Write Testable and Maintainable Code in PHP</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://wadehuang1993.github.io/blog/2019/11/26/how_to_write_testable_and_maintainable_code_in_php/" data-id="ck3jtryoc0005b5p1fd9z2718" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/blog/2019/11/22/cluelessness_in_self_learning/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">自學時應該看破“無緒”</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/OOP/" rel="tag">OOP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/SOLID-principles/" rel="tag">SOLID principles</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/SRP-principle/" rel="tag">SRP principle</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">標籤雲</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/OOP/" style="font-size: 10px;">OOP</a> <a href="/blog/tags/SOLID-principles/" style="font-size: 10px;">SOLID principles</a> <a href="/blog/tags/SRP-principle/" style="font-size: 10px;">SRP principle</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">彙整</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2019/10/">十月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2019/11/26/how_to_write_testable_and_maintainable_code_in_php/">如何撰寫可測試與可維護 PHP 程式碼</a>
          </li>
        
          <li>
            <a href="/blog/2019/11/22/cluelessness_in_self_learning/">自學時應該看破“無緒”</a>
          </li>
        
          <li>
            <a href="/blog/2019/11/21/Cluelessness/">軟體開發中的“無緒”</a>
          </li>
        
          <li>
            <a href="/blog/2019/11/04/solid_srp_definition_and_practices/">單一職責原則，定義、解析與實踐</a>
          </li>
        
          <li>
            <a href="/blog/2019/11/01/why_we_need_SOLID_principles/">再談 SOLID 原則，Why SOLID?</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 WadeHuangTW1993<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">首頁</a>
  
    <a href="/blog/archives" class="mobile-nav-link">文章列表</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>



  </div>
</body>
</html>